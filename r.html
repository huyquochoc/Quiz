<script>
const JSON_URL = "https://huyquochoc.github.io/Quiz/shortlinks.json";

const params = new URLSearchParams(window.location.search);
const key = params.get("id");

const statusEl = document.getElementById("status");
const msgEl = document.getElementById("msg");

if (!key) {
  statusEl.textContent = "❌ Thiếu mã link";
  msgEl.textContent = "Không tìm thấy tham số ?id=";
  throw new Error("Missing id");
}

fetch(JSON_URL)
  .then(r => r.json())
  .then(data => {
    console.log("JSON loaded:", data);
    console.log("Key requested:", key);

    if (!data[key]) {
      statusEl.textContent = "❌ Link không tồn tại";
      msgEl.textContent = "Mã link không hợp lệ hoặc đã bị xóa";
      return;
    }

    const record = data[key];

    if (!record.url) {
      statusEl.textContent = "❌ JSON sai cấu trúc";
      msgEl.textContent = "Thiếu trường url trong shortlinks.json";
      return;
    }

    const url = record.url;
    const expire = record.expire;

    // ===== CHECK EXPIRE =====
    if (expire) {
      const today = new Date().toISOString().split("T")[0];
      if (today > expire) {
        statusEl.textContent = "⛔ Link đã hết hạn";
        msgEl.textContent = "Vui lòng liên hệ giáo viên để lấy link mới";
        return;
      }
    }

    // ===== REDIRECT =====
    statusEl.textContent = "✅ Đang chuyển hướng...";
    msgEl.textContent = "Vui lòng chờ...";

    console.log("Redirect to:", url);

    setTimeout(() => {
      window.location.href = url;
    }, 600);
  })
  .catch(err => {
    console.error("Fetch error:", err);
    statusEl.textContent = "⚠️ Lỗi tải dữ liệu";
    msgEl.textContent = "Không thể tải shortlinks.json";
  });
</script>
